## v0.4.0 - 2026-02-28


#### Added

##### Typed metadata values (#58)

Replace stringly-typed `Metadata` with a `MetadataValue` sum type (`StringVal`, `IntVal`, `FloatVal`, `BoolVal`). New `birch/meta` module provides ergonomic constructors (`meta.string`, `meta.int`, `meta.float`, `meta.bool`). JSON handler now outputs typed values instead of strings.

##### Scoped default logger override (#59)

New \`birch.with_logger(lgr, fn() { ... })\` function temporarily overrides the default logger within a scope. Useful for silencing logs in subsystems (e.g., TUI apps) without affecting the rest of the application. Composes with \`with_scope\`.

##### RFC 5424 log levels: Notice, Critical, Alert (BREAKING)

The `Level` type now includes `Notice`, `Critical`, and `Alert` variants following RFC 5424 syslog severity levels. New convenience functions added: `birch.notice()`, `birch.critical()`, `birch.alert()` and corresponding `logger.notice()`, `logger.critical()`, `logger.alert()` with lazy variants. Level integer values have been renumbered (Warn=4, Err=5, Critical=6, Alert=7, Fatal=8). **Breaking**: exhaustive pattern matches on `Level` must be updated to handle the new variants, and code relying on `to_int` values for Warn/Err/Fatal will see different numbers.

##### OTP structured report support via `report_cb` (#90)

The birch `:logger` formatter now checks for `report_cb` callbacks in OTP log event metadata. Supports both 1-arg (returns chardata) and 2-arg (returns `{Format, Args}`) callbacks with `try/catch` fallback to `~p` on failure. OTP libraries that emit structured reports (e.g., supervisor, gen_server) now render human-readable messages instead of raw Erlang terms.


#### Changed

##### Migrate `sampling` config from `Result` to `Option` (BREAKING)

`GlobalConfig.sampling` changed from `Result(SampleConfig, Nil)` to `Option(SampleConfig)`. Migrate from `Ok(config)` / `Error(Nil)` to `Some(config)` / `None`.

##### Default BEAM config sends logs directly to `:logger` — no birch handler needed (BREAKING)

On Erlang, `emit_record()` now sends each LogRecord directly to `:logger` with the full record in metadata. The default handler list is empty (was `[forward_to_beam()]`). The birch formatter installed on `:logger`'s default handler receives the intact LogRecord and formats it — no decompose/recompose step. Users who explicitly passed `forward_to_beam()` in `config_handlers()` should remove it. The JavaScript target is unchanged.


#### Deprecated

##### Deprecate `forward_to_logger()` and related functions

`forward_to_logger()`, `forward_to_logger_with_formatter()`, and `forward_to_logger_raw()` are deprecated in favor of `forward_to_beam()`. The old functions either discarded log levels or had a confusing name. The legacy handler-based API (`install_logger_handler()`, `uninstall_logger_handler()`) is also deprecated in favor of `install_formatter()` and `remove_formatter()`.

##### Deprecate type aliases and `logger_` prefix functions

Top-level type aliases (`LogLevel`, `LogHandler`, `LogMetadata`, `Config`, `TimestampFormatter`) are deprecated — use the types from their respective modules directly (e.g., `birch/level.Level`). The `logger_` prefix functions (`logger_info`, `logger_debug`, etc.) are deprecated in favor of calling `birch/logger` functions directly (e.g., `logger.info(lgr, msg, meta)`).

##### Deprecate `forward_to_beam()` handler

`forward_to_beam()` is no longer needed — birch sends LogRecords directly to `:logger` on BEAM without a handler wrapper. Remove it from your handler list; logs go through `:logger` automatically.


#### Fixed

##### Fix `unregister_writer` no-op causing memory leak (#83)

The `unregister_writer` function in the Erlang FFI always returned early because `whereis(?MODULE)` is never a registered process. Async writers were never removed from `persistent_term`, causing a slow memory leak in long-running systems.

##### Add exception safety to Erlang scoped context (#83)

If `work()` panicked inside `with_scope` or `with_scoped_logger` on the Erlang target, the process dictionary was never restored — permanently corrupting scope context for OTP processes. Added `try/after` FFI helpers to guarantee cleanup. The JavaScript target already handled this correctly.

##### Fix Block overflow strategy silently discarding records (#83)

The `Block` overflow strategy in the Erlang async writer called `flush_queue` with a dummy callback, discarding all pending records instead of writing them. The real callback is now passed through correctly.

##### Handle async actor start failure gracefully (#83)

`make_async` previously used `let assert` which would crash the application if the OTP actor failed to start. It now falls back to synchronous logging with a warning to stderr, consistent with birch's philosophy that handler failures never crash the application.

##### Wrap OTP logger metadata in proper `MetadataValue` tags (#83)

The Erlang `:logger` formatter FFI returned raw binaries for metadata values, but Gleam's `Metadata` type expects tagged `MetadataValue` unions. Values are now correctly wrapped as `StringVal`, `IntVal`, `FloatVal`, or `BoolVal` with proper type detection (including boolean-before-atom guard ordering).

##### Fix Deno 2.0 TTY detection

Use `Deno.stdout.isTerminal()` for Deno 2.0+ with fallback to legacy `isatty(rid)` API. The `rid` property was removed in Deno 2.0, silently disabling color output.

##### Fix cross-platform scope context parity

Removed unused `_scope_highlight_keys` internal metadata that was only injected on the JavaScript target, causing behavioral divergence from the Erlang target. Also removes the `StringVal` import coupling to Gleam codegen internals in `birch_ffi.mjs`.

##### Fix misleading deprecation messages for `_m` suffix functions

Deprecation messages previously pointed to non-existent overloads like `info(message, metadata)`. They now correctly direct users to `birch/logger` (e.g., `birch/logger.info(logger, message, metadata)`).

##### Update doc comments and examples to use current API

Fixed module doc comments in `birch.gleam` and `scope.gleam` that showed deprecated or non-compiling code. Updated examples README to reference `birch/meta` and `birch/logger` instead of deprecated `_m` variants and `logger_` functions.

##### Fix `:logger` forwarding always logging at info level

`forward_to_logger()` silently discarded the log record's severity, sending every message to Erlang's `:logger` at the `info` level. Warnings, errors, and fatal messages all appeared as informational. Use the new `forward_to_beam()` handler which preserves levels correctly.

##### Fix Erlang level mapping collapsing alert, critical, and notice

The Erlang-to-Gleam level conversion incorrectly mapped `alert` and `critical` to `Fatal`, and `notice` to `Info`, losing severity distinctions. These now map 1:1 to their corresponding Gleam levels (`Alert`, `Critical`, `Notice`).

##### Eliminate double-formatting of log messages on BEAM (#87)

Previously, birch formatted a message string via the handler, passed it to `:logger`, and the birch formatter would try to format it again — producing garbled output with duplicate timestamps and metadata. LogRecords now pass through `:logger` intact and the formatter uses them directly.


#### Performance

##### Cache default logger (#60)

The default logger is now cached and only rebuilt when configuration changes via \`configure()\`, \`set_level()\`, or \`reset_config()\`. Previously it was reconstructed on every log call.


#### Security

##### Prevent log injection via metadata values

Metadata values containing quotes, newlines, or carriage returns are now properly escaped in human-readable formatter output. Previously, an attacker who controlled metadata values could forge log lines via newline injection.

##### Fix gzip argument injection on Deno

Added `--` end-of-options marker before file path in Deno gzip command to prevent paths starting with `-` from being interpreted as flags.

